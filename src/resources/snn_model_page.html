<!DOCTYPE html>
<html style="height: 640px;width: 100%;">

<head>
  <meta charset="UTF-8">
  <title>SNN模型</title>
</head>

<body class="dark-mode" style="height: 100%;width: 100%;white-space: nowrap;overflow: auto;">

  <div class="loading-div">
    <i class="fa fa-spinner fa-pulse fa-3x fa-fw" style="display: block;margin-left: 50vw;"></i>
    <span style="color: #333;height: 50px;width: 120px;margin-left: calc(50vw - 20px);display: block;"><font style="color: #333;font-weight: bolder;">数据信息加载中...</font></span>
  </div>

    <div style="height: 400px;">
        <!-- SNN神经元信息 -->
        <div style="display: inline-block;background: rgba(238,238,238,0.4); height: 400px;width: 500px;">
            <div id="model_layers_vis_tab_caption" style="text-align: center;"><font style="font-family: SourceHanSansCN-Normal;
              font-size: 20px;
              color: #333333;
              letter-spacing: 1.14px;">脉冲神经网络神经元组信息</font></div>
            <table id="snn_neurons_table" style="margin-left:10px;margin-left: 20px;border: solid 3px #D6D6D6;width: 440px;">
                <caption class="white-text" style="caption-side: top;text-align: center;"></caption>
                <thead>
                  <tr style="margin-top: 15px;border: solid 2px #D6D6D6;color: #333;">
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">layer编号</td>
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">神经元个数</td>
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">求解方法</td>
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">电压阈值</td>
                  </tr>
                  <!-- 动态加载 -->
                </thead>
            </table>
        </div>

        <div style="display: inline-block;background: rgba(238,238,238,0.4);height: 400px;width: 500px;">
          <div style="text-align: center;"><font style="font-family: SourceHanSansCN-Normal;
            font-size: 20px;
            color: #333333;
            letter-spacing: 1.14px;">层连接权重统计</font></div>
          <table id="snn_layer_wt_table" style="border: solid 3px #D6D6D6;width: 380px;margin-left: 60px;">
            <caption class="white-text" style="caption-side: top;text-align: center;"></caption>
            <thead>
              <tr style="margin-top: 15px;border: solid 2px #D6D6D6;color: #333;">
                <td style="width: 80px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                font-size: 16px;
                color: #666666;padding-top: 12px; padding-bottom: 12px;">layer编号</td>
                <td style="width: 80px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                font-size: 16px;
                color: #666666;padding-top: 12px; padding-bottom: 12px;">权重均值</td>
                <td style="width: 80px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                font-size: 16px;
                color: #666666;padding-top: 12px; padding-bottom: 12px;">权重方差</td>
              </tr>
            </thead>
          </table>
        </div>

        <div style="height: 400px;margin-top: 20px;display: inline-block;background: rgba(238,238,238,0.4);width: 500px;">
            <div id="model_layers_vis_tab_caption" style="text-align: center;"><font style="font-family: SourceHanSansCN-Normal;
              font-size: 20px;
              color: #333333;
              letter-spacing: 1.14px;">脉冲神经网络突触连接信息</font></div>
            <table id="layer_conns_table" style="margin-left:60px;border: solid 3px #D6D6D6;width: 400px;">
                <caption class="white-text" style="caption-side: top;text-align: center;"></caption>
                <thead>
                  <tr style="margin-top: 15px;border: solid 2px #D6D6D6;color: #333;">
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">layer编号</td>
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">连接稠密度</td>
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">平均连接个数</td>
                  </tr>
                  <!-- 动态加载 -->
                </thead>
            </table>
        </div>
    </div>
    <div style="height: 460px;margin-top: 30px;">
        <!--权重分布图-->
        <div style="height: 460px;width: 770px;display: inline-block;vertical-align: top;background: rgba(238,238,238,0.4);">
            <div id="model_layers_vis_tab_caption" style="text-align: center;"><font style="font-family: SourceHanSansCN-Normal;
              font-size: 20px;
              color: #333333;
              letter-spacing: 1.14px;">脉冲神经网络权重分布</font></div>
            <div id="weight_dist_chart" style="width: 700px;height: 400px;margin-left: 40px;margin-top: 10px;"></div>
        </div>
        <div style="height: 460px;width: 740px;display: inline-block;vertical-align: top;background: rgba(238,238,238,0.4);">
            <div style="text-align: center;"><font style="font-family: SourceHanSansCN-Normal;
              font-size: 20px;
              color: #333333;
              letter-spacing: 1.14px;">模型连接图</font></div>
            <div id="sangky_chart" style="width: 700px;height: 400px;display: inline-block;margin-left: 20px;"></div>
        </div>
    </div>
</body>
<style>

.titlebar {
  -webkit-user-select: none;
  -webkit-app-region: drag;
}

.titlebar-button {
  -webkit-app-region: no-drag;
}

body {
  padding: 25px;
  background-color: rgb(251, 255, 255);
  color: white;
  font-size: 25px;
}

.dark-mode {
  background-color: rgb(249, 251, 252);
  color: white;
}


  @font-face {
    font-family: 'Material Icons';
    font-style: normal;
    font-weight: 400;
    src: local('Material Icons'), local('MaterialIcons-Regular'), url(https://fonts.gstatic.com/s/materialicons/v7/2fcrYFNaTjcS6g4U3t-Y5ZjZjT5FdEJ140U2DJYC3mY.woff2) format('woff2');
  }

  .material-icons {
    font-family: 'Material Icons';
    font-weight: normal;
    font-style: normal;
    font-size: 24px;
    line-height: 1;
    text-transform: none;
    display: inline-block;
    -webkit-font-feature-settings: 'liga';
    -webkit-font-smoothing: antialiased;
  }

  .loading-div {
      width: calc(100vw);
      height: calc(100vh);
      display: table-cell;
      vertical-align: middle;
      color: #555;
      overflow: hidden;
      text-align: center;
  }
  .loading-div::before {
      display: inline-block;
      vertical-align: middle;
  } 
</style>
<!-- Compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" href="http://localhost:6003/css/font-awesome.min.css">

<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.8.0/echarts-en.min.js"></script>

<script>
      $(document).ready(function(){
          window.addEventListener("message", function(evt){
            console.log("SNN 模型可视化接收到extension 消息: ");
              const data = JSON.parse(evt.data);
              if(data.snn_info){
                  var infos =JSON.parse(data.snn_info);
                  console.log("显示snn 基本信息......");
                  // 构建neurons info 表格
                  var neurons_info = infos.neurons_info;
                  var neurons_table = document.getElementById("snn_neurons_table");
                  for(var i=0;i<neurons_info.length;++i){
                      var line = document.createElement("tr");
                      line.style = "margin-top: 15px;border: solid 3px #D6D6D6;color: #333;"
                      var col_1 = document.createElement("td");
                      col_1.style = "text-align:center; padding-right:15px; font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      col_1.innerText = neurons_info[i].idx;

                      var col_2 = document.createElement("td");
                      col_2.style = "border: solid 3px #D6D6D6;text-align:right; padding-right:15px;;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      col_2.innerText = neurons_info[i].neuron_count;

                      var col_3 = document.createElement("td");
                      col_3.style = "border: solid 3px #D6D6D6;padding-left:10px;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      col_3.innerText = neurons_info[i].method;

                      var col_4 = document.createElement("td");
                      col_4.style = "border: solid 3px #D6D6D6;text-align:right; padding-right:15px;;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      col_4.innerText = neurons_info[i].vthresh;

                      line.appendChild(col_1);
                      line.appendChild(col_2);
                      line.appendChild(col_3);
                      line.appendChild(col_4);

                      neurons_table.appendChild(line);
                  }
                  // 构建突触表格
                  var synaps_info = infos.layer_conns;
                  var synaps_table = document.getElementById("layer_conns_table");
                  for(var i=0;i<synaps_info.length;++i){
                      var line = document.createElement("tr");
                      line.style = "margin-top: 15px; border: solid 3px #D6D6D6; color:#333;";
                      var col_1 = document.createElement("td");
                      col_1.style = "text-align:center; padding-right:15px;border: solid 3px #D6D6D6;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      col_1.innerText = synaps_info[i].idx;

                      var col_2 = document.createElement("td");
                      col_2.style = "border: solid 3px #D6D6D6;text-align:right; padding-right:15px;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      col_2.innerText = synaps_info[i].ratio;

                      var col_3 = document.createElement("td");
                      col_3.style = "border: solid 3px #D6D6D6;text-align:right; padding-right:15px;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      col_3.innerText = synaps_info[i].avg_conn;

                      line.appendChild(col_1);
                      line.appendChild(col_2);
                      line.appendChild(col_3);
                      synaps_table.appendChild(line);
                  }

                  // 绘制权重分布图
                  for(var i=0;i<infos.layers_weights.wt_count.length;++i){
                      infos.layers_weights.wt_count[i] = Math.log10(infos.layers_weights.wt_count[i]);
                  }
                  console.log("权重数据："+infos.layers_weights.wt_label);
                  console.log("数值:"+infos.layers_weights.wt_count)
                  display_weight_chart(infos.layers_weights.wt_label, infos.layers_weights.wt_count);

                  // 仿真配置与结果表格
                  $("#simulate_vthresh").text(infos.extra_simu_info.simulate_vthresh);
                  $("#simulate_neuron_dt").text(infos.extra_simu_info.simulate_neuron_dt);
                  $("#simulate_synapse_dt").text(infos.extra_simu_info.simulate_synapse_dt);
                  $("#simulate_delay").text(infos.extra_simu_info.simulate_delay);
                  $("#simulate_dura").text(infos.extra_simu_info.simulate_dura);
                  $("#simulate_acc").text(infos.extra_simu_info.simulate_acc);


                  // 添加SNN各层权重信息
                  for(let i=0;i<infos.record_layers_wt_info.record_wts_avg.length;++i){
                    let table_line = document.createElement("tr");
                    table_line.style.marginTop = "15px";
                    table_line.style.border = "solid 3px #D6D6D6";
                    table_line.style.color = "#333";

                    let td_id = document.createElement("td");
                    // font-family: ArialMT;font-size: 14px;color: #333333;
                    td_id.style.fontSize = "14px";
                    td_id.style.fontFamily = "ArialMT";
                    td_id.style.color = "#333333";
                    td_id.style.width = "120px";
                    td_id.style.border = "solid 3px #D6D6D6";
                    td_id.style.textAlign = "center";
                    td_id.style.paddingRight = "15px";
                    td_id.style.paddingTop = "12px";
                    td_id.style.paddingBottom = "12px";
                    td_id.innerText = ""+i;
                    table_line.appendChild(td_id);

                    let td_avg = document.createElement("td");
                    td_avg.style.fontSize = "14px";
                    td_avg.style.fontFamily = "ArialMT";
                    td_avg.style.color = "#333333";
                    td_avg.style.width = "120px";
                    td_avg.style.border = "solid 3px #D6D6D6";
                    td_avg.style.textAlign = "right";
                    td_avg.style.paddingRight = "15px";
                    td_avg.style.paddingTop = "12px";
                    td_avg.style.paddingBottom = "12px";
                    td_avg.innerText = infos.record_layers_wt_info.record_wts_avg[i];
                    table_line.appendChild(td_avg);

                    let td_std = document.createElement("td");
                    td_std.style.fontSize = "14px";
                    td_std.style.fontFamily = "ArialMT";
                    td_std.style.color = "#333333";
                    td_std.style.width = "120px";
                    td_std.style.textAlign = "right";
                    td_std.style.paddingRight = "15px";
                    td_std.style.border = "solid 3px #D6D6D6";
                    td_std.style.paddingTop = "12px";
                    td_std.style.paddingBottom = "12px";
                    td_std.innerText = infos.record_layers_wt_info.record_wts_std[i];
                    table_line.appendChild(td_std);

                    document.getElementById("snn_layer_wt_table").appendChild(table_line);

                  }

                  $(".loading-div").hide(); // 隐藏加载提示

            //       <table id="snn_layer_wt_table" style="width: 320px;">
            // <caption class="white-text" style="caption-side: top;text-align: center;"></caption>
            // <thead>
            //   <tr style="margin-top: 15px;border: solid 3px;">
            //     <td style="font-size: medium;font-weight: bold;width: 120px;padding-left: 10px;">layer编号</td>
            //     <td style="font-size: medium;font-weight: bold;width: 120px;">权重均值</td>
            //     <td style="font-size: medium;font-weight: bold;width: 120px;">权重方差</td>
            //   </tr>
            // </thead>

    //         "record_layers_wt_info":{
    //     "record_wts_avg":record_layers_wt_avg,
    //     "record_wts_std":record_layers_wt_std
    // }

                  // // SNN模型简图
                  // let sanky_data=new Array();
                  // let sanky_links=new Array();
                  // for(let i=0;i<infos.layer_conns.length+1;++i){
                  //     sanky_data.push({"name": "layer_"+i});
                  // }
                  // for(let i=0;i<infos.layer_conns.length;++i){
                  //     sanky_links.push({"source":"layer_"+i, "target":"layer_"+(i+1), "value": infos.layer_conns[i].ratio, "lineStyle":{"color": "#c23531"}});
                  // }
                //   console.log("Display sanky graph, sanky_data="+sanky_data[0]['name']);
                  // console.log("Display sanky links, ="+sanky_links['0']['value']);
                  // display_snn_model_sanky(sanky_data, sanky_links);
              }else if(data.snn_map){
                console.log("显示SNN 结构图.....");
                net_structure_show("sangky_chart", data.snn_map);
              }
          });
      });

      function display_weight_chart(label_names, label_counts){
          var opt = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: '#999'
                        }
                    }
                },
                xAxis: {
                    type: 'category',
                    data: label_names,
                    name:"权重",
                    nameTextStyle:{
                      color:"#999999",
                      fontFamily: 'SourceHanSansCN-Normal',
                      fontSize: '14px',
                    },
                    axisLabel:{
                      textStyle:{
                        color:"#999999"
                      },
                      fontFamily: 'SourceHanSansCN-Normal',
                      fontSize: '14px',
                   }
                },
                yAxis: {
                    type: 'value',
                    name:"连接个数(log_10)",
                    nameTextStyle:{
                      color:"#999999",
                      fontFamily: 'SourceHanSansCN-Normal',
                      fontSize: '14px',
                    },
                    scale:true,
                    axisLabel: {
                        formatter: '{value}',
                        textStyle:{
                          color:"#999999"
                        },
                        fontFamily: 'SourceHanSansCN-Normal',
                        fontSize: '14px',
                    }
                },
                series: [{
                    data: label_counts,
                    type: 'bar'
                }]
            };
            var weights_chart = echarts.init(document.getElementById("weight_dist_chart"));
            weights_chart.setOption(opt);
      }

      function display_snn_model_sanky(chart_data, chart_links){
          let option={
            series: {
                    type: 'sankey',
                    layout: 'none',
                    emphasis: {
                        focus: 'adjacency'
                    },
                    data: chart_data,
                    links: chart_links
                }
          };

          var sanky_chart_ = echarts.init(document.getElementById("sangky_chart"));
          sanky_chart_.setOption(option);
      }

      function net_structure_show(elementId, map_file_url) {
                // 基于准备好的dom，初始化echarts实例
                var myChart = echarts.init(document.getElementById(elementId)); //初始化
                console.log("SNN 结构 div 显示 loading...");
                myChart.showLoading();
                $.get(map_file_url, function (map_file) {
                    var node_data = map_file.data;
                    var node_link = map_file.links;
                    var node_class = map_file.layers;
                    var ratios = map_file.ratio;
                    var num = map_file.nums;
                    console.log("加载完毕map json 数据....");
                    console.log("ratios = "+ratios);
                    var categories = [];
                    for (var i = 0; i < node_class.length; i++) {
                        categories[i] = {
                            name: node_class[i],
                        };
                    }
                    console.log("categories finished...");
                    // 指定图表的配置项和数据
                    let option = {
                        title: {
                            show: true,
                            // text: 'Network Structure Diagram',
                            text: 'ratio     1 : ' + ratios,
                            textStyle:{
                                color:"#333333",
                                fontFamily: 'SourceHanSansCN-Normal',
                                fontSize: '14px',
                            },
                            bottom: '3%',
                            left: 'center'
                        },
                        tooltip: {}, //提示信息
                        legend: {   //图例组件
                            // top: "0%",   //距离顶部5%
                            // bottom: "88%",
                            // left: "5%",
                            orient:'vertical',
                            x:'left',
                            y:'center',
                            data: node_class,
                            formatter: function (name) {
                                var neuron_num;
                                for (var i = 0; i < node_class.length; i++) {
                                    if (node_class[i] === name) {
                                        neuron_num = num[i];
                                        break;
                                    }
                                }
                                // var arr = [
                                //     name,
                                //     '(' + neuron_num + ')'
                                // ];
                                var arr = [
                                    '{a|' + name + '}',
                                    '{b|(' + neuron_num + ')}'
                                ];
                                return arr.join('\\n');
                            },
                            textStyle: {
                                rich: {
                                    a: {
                                        fontSize: 14,
                                        verticalAlign: 'top',
                                        align: 'center',
                                        padding: [0, 0, 5, 0],
                                        color:"#333333",
                                        fontFamily: 'SourceHanSansCN-Normal',
                                        letterSpacing: '0.8px'
                                    },
                                    b: {
                                        fontSize: 8,
                                        align: 'center',
                                        padding: [0, 10, 0, 0],
                                        lineHeight: 25,
                                        color:"#333333",
                                        fontFamily: 'SourceHanSansCN-Normal',
                                        letterSpacing: '0.8px'
                                    }
                                },
                                color:"#333333",
                                fontFamily: 'SourceHanSansCN-Normal',
                                fontSize: '14px',
                            }
                        },
                        animationDuration: 1500,
                        animationEasingUpdate: "quinticInOut",
                        series: [ //系列列表
                            {

                                name: "Les Miserables",  //系列名称
                                type: "graph",   //系列图表类型  ——  关系图
                                // layout: "circular",
                                // top: "15%",
                                // bottom: "8%",
                                symbolSize: 5,  //图元的大小
                                data: node_data,
                                links: node_link,
                                roam: true,
                                // focusNodeAdjacency: true,
                                categories: categories,
                            },
                        ],
                    };

                    console.log("option init finished....");
                    // 使用刚指定的配置项和数据显示图表。
                    myChart.hideLoading();
                    myChart.setOption(option); //使用json
                });
            }
</script>

</html>
