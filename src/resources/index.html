<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.js" integrity="sha512-E378bwaeZf1nwXeJGIwTB58A5gPt5jFU3u6aTGja4ZdRFJeo/N/REKnBgNZOZlH6JdnOPO98vg2AnSGaNfCMFQ==" crossorigin="anonymous"></script>
    <style type="text/css">
        .circle{
            width: 30px;
            height: 30px;
            background: rgb(14, 18, 219);
            -webkit-border-radius:35px;
            border-radius: 35px;
            vertical-align:middle;
        }
        .arrow-right:after {
                content: "";
                display: inline-block !important;
                width: 0;
                height: 0;
                border-left: 8px solid #C8A962;
                border-top: 8px solid transparent;
                border-bottom: 8px solid transparent;
                vertical-align: middle;

            }
            .arrow-right:before {
                width: 20px;
                height: 2px;
                background: #C8A962;
                content: "";
                display: inline-block;
                vertical-align: middle;
            }
    </style>
    <title>Darwin IDE</title>
</head>

<body style="height: 100%;">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4>Darwin IDE</h4>
        </div>
        <div class="panel-body">
            <ul class="nav nav-tabs">
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        开始
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="#"></a>
                        </li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        公共功能菜单栏
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="#"></a>
                        </li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        帮助
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="#"></a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
    <!--功能按键区面板-->
    <div class="panel panel-default col-md-2 col-sm-2">
        <div class="panel-heading">
            <h3 class="panel-title">功能区</h3>
        </div>
        <div class="panel-body">
            <input type="file" id="upload_ann_model" style="visibility: hidden;"/>
            <input type="file" id="upload_testdata" style="visibility: hidden;" webkitdirectory directory multiple/>
            <button id="import_test_data_btn" type="button" class="btn btn-primary">导入测试数据</button>
            <br />
            <br />
            <br />
            <button id="start_data_preprocess_btn" type="button" class="btn btn-primary">数据预处理</button>
            <br />
            <br />
            <br />
            <button id="ann_conversion_btn" type="button" class="btn btn-primary">ANN模型参数调整</button>
            <br />
            <br />
            <br />
            <button id="ann_convert_snn_simulate" type="button" class="btn btn-primary">ANN模型转SNN与仿真</button>
            <br/>
            <br/>
            <br/>
            <button id="import_snn_btn" type="button" class="btn btn-primary">SNN模型导入</button>
            <br />
            <br />
            <br />
            <button id="import_snn_btn" type="button" class="btn btn-primary">SNN模型训练</button>
            <br />
            <br />
            <br />
            <button id="import_snn_btn" type="button" class="btn btn-primary">SNN模型编译</button>
            <br />
            <br />
            <br />
            <button id="import_snn_btn" type="button" class="btn btn-primary">SNN模型仿真</button>
            <br />
            <br />
            <br />
            <button id="import_snn_btn" type="button" class="btn btn-primary">SNN模型运行</button>
        </div>
    </div>
    <!--可视化区面板-->
    <div class="panel panel-default col-md-8 col-sm-8" style="min-height: 500px;">
        <div class="panel-heading">
            可视化区
        </div>
        <div class="panel-body">
            <!--可视化展示-->
            <article style="height: 100%; width: 100%;">
                <div id="circle1" class="circle" style="height: 65px;width: 65px;display: inline-block;">
                    <span style="color: rgb(248, 252, 252); width: 65px; height: 65px;display: inline-block;text-align: center;">
                        测试<br/>数据<br/>加载
                    </span>
                </div>
                <div id="arrow1" class="arrow-right" style="height: 60px;width: 60px;display: inline-block;"></div>
                <div id="circle2" class="circle" style="height: 65px;width: 65px;display: inline-block;">
                    <span style="color: rgb(248, 252, 252); width: 65px; height: 65px;display: inline-block;text-align: center;">
                        数据<br/>预处理
                    </span>
                </div>
                <div id="arrow2" class="arrow-right" style="height: 60px;width: 60px;display: inline-block;"></div>
                <div id="circle3" class="circle" style="height: 65px;width: 65px;display: inline-block;">
                    <span style="color: rgb(248, 252, 252); width: 65px; height: 65px;display: inline-block;text-align: center;">
                        参数<br/>调整</br>与校验
                    </span>
                </div>
                <div id="arrow3" class="arrow-right" style="height: 60px;width: 60px;display: inline-block;"></div>
                <div id="circle4" class="circle" style="height: 65px;width: 65px;display: inline-block;">
                    <span style="color: rgb(248, 252, 252); width: 65px; height: 65px;display: inline-block;text-align: center;">
                        模型<br/>转换</br>仿真
                    </span>
                </div>
            </article>
        </div>
    </div>
    <!--参数配置区-->
    <div class="panel panel-default col-md-2 col-sm-2">
        <div class="panel-heading">
            参数配置区
        </div>
        <div class="panel-body">
            <!--参数配置-->
            <form class="bs-example bs-example-form" role="form">
                <div class="input-group">
                    <span class="input-group-addon">膜电位权重位宽(bit)</span>
                    <input type="text" class="form-control" placeholder="8">
                </div>
                <br />
                <div class="input-group">
                    <span class="input-group-addon">权重位宽(bit)</span>
                    <input type="text" class="form-control" placeholder="8">
                </div>
            </form>

        </div>
    </div>
    <!--运行信息输出区-->
    <div class="panel panel-default col-md-9 col-sm-9" style="height: 300px;">
        <input type="file" id="save_log_file_select" style="visibility: hidden;" webkitdirectory directory/>
        <button id="clear_btn" class="btn btn-warning" style="position: relative;left: 3px; top: 10px;width: 100px;height: 30px;display: inline;">清除日志</button>
        <button id="save_log_btn" class="btn btn-info" style="position: relative;left: 3px;top: 10px;width: 100px;height: 30px;display: inline;">保存日志</button>
        <div class="panel-body" style="overflow-x: auto;overflow-y: auto;">
            <!--输出区标签-->
            <ul id="outputTab" class="nav nav-tabs">
                <li class="active">
                    <a href="#annOutput" data-toggle="tab">
                        ANN校验日志输出
                    </a>
                </li>
                <li>
                    <a href="#snnOutput" data-toggle="tab">
                        SNN校验日志输出
                    </a>
                </li>
            </ul>
            <!--运行信息输出区 标签页对应的数据区-->
            <div class="tab-content" style="overflow-x: auto;overflow-y: auto; height: 180px;width: 100%;" id="outputPanel">
                <div class="tab-pane fade in active"  style="overflow-x: auto;overflow-y: auto; height: 180px;width: 100%;" id="annOutput">
                    <!-- ANN校验输出内容 -->
                </div>
                <div class="tab-pane fade"  style="overflow-x: auto;overflow-y: auto; height: 180px;width: 100%;" id="snnOutput">
                    <!-- SNN校验输出内容 -->
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    // anime({
    //     targets:"#circle1",
    //     backgroundColor:["rgb(14, 18, 219)","rgb(50, 205, 50)","rgb(14, 18, 219)"],
    //     easing:'easeInOutQuad',
    //     duration:3000,
    //     loop:true
    // });
    // setTimeout('anime.remove("#circle1")',6000);
    let currentStage=0;
    const vscode = acquireVsCodeApi();
    // 点击上传ANN 模型，启动模型加载、转换与校验
    $("#ann_conversion_btn").click(function () {
        $("#upload_ann_model").click();
    });
    $("#import_test_data_btn").click(function(){
        anime({
                targets:"#circle1",
                backgroundColor:["rgb(14, 18, 219)","rgb(50, 205, 50)"],
                easing:'easeInOutQuad',
                duration:1000,
                loop:false
        });
        setTimeout(() => {
            $("#upload_testdata").click();
        }, 1000);
    });
    // 清除日志内容
    $("#clear_btn").click(function(){
        $("#annOutput").html("");
    });

    // 保存日志
    $("#save_log_btn").click(function(){
        $("#save_log_file_select").click();
    });

    $("#save_log_file_select").change(function(){
        console.log("save log file");
        let dirPath = $("#save_log_file_select").prop("files")[0].path;
        dirPath = dirPath.substring(0,dirPath.lastIndexOf("\\"));
        console.log("目录的路径为："+dirPath);
        dirPath = dirPath.split("\\").join("\\\\");
        let logData = $("#annOutput").html();
        logData = logData.split("<br/>").join("\r\n");
        logData = logData.split("<br>").join("\r\n");
        // 发送
        vscode.postMessage(JSON.stringify({"saveLogFile":dirPath.toString(),"logData":logData.toString()}));
    });
    

    // let annModelPath = undefined;
    // $("#upload_file").change(function () {
    //     console.log("上传文件");
    //     console.log($("#upload_file").prop("files"));
    //     console.log($("#upload_file").prop("files")[0].path);
    //     annModelPath = $("#upload_file").prop("files")[0].path;
    //     console.log("上传文件，选择的文件路径为："+annModelPath);
    //     vscode.postMessage(JSON.stringify({"upload_ann_model_path":annModelPath.toString()})+"");
    // });
    $("#upload_testdata").change(function(){
        console.log("上传测试数据");
        setTimeout(()=>{
            anime({
                targets:"#circle1",
                backgroundColor:["rgb(50, 205, 50)", "rgb(14, 18, 219)"],
                easing:'easeInOutQuad',
                duration:1000,
                loop:false
            });
        }, 1000);
        setTimeout(() => {
            anime.remove("#circle1");
        }, 2000);
        console.log($("#upload_testdata").prop("files"))
        let dirPath = $("#upload_testdata").prop("files")[0].path;
        console.log("dir path="+dirPath);
        dirPath = dirPath.substring(0, dirPath.lastIndexOf("\\"));
        dirPath = dirPath.substring(0, dirPath.lastIndexOf("\\"));
        console.log("目录的路径为："+dirPath);
        // windows 环境下路径处理
        dirPath = dirPath.split("\\").join("\\\\");
        // 将测试数据的目录路径发送到插件
        vscode.postMessage(JSON.stringify({"upload_testdata_dirpath":dirPath.toString()}));
    });
    // post message from webview to extension
    $("#start_data_preprocess_btn").click(function () {
        // 数据预处理
        // console.log("ann model path:" + annModelPath);
        console.log("data preprocess start!");
        anime({
                targets:"#circle2",
                backgroundColor:[ "rgb(14, 18, 219)","rgb(50, 205, 50)"],
                easing:'easeInOutQuad',
                duration:1000,
                loop:true
        });
        vscode.postMessage(JSON.stringify({"start_data_preprocess":"start"})+"");
    });

    $("#upload_ann_model").change(function(){
        // ANN模型转换与检验
        console.log("start ann conversion and check.");
        anime({
            targets:"#circle3",
            backgroundColor:["rgb(14, 18, 219)", "rgb(50, 205, 50)"],
            easing:"easeInOutQuad",
            duration:1000,
            loop:true
        });
        console.log($("#upload_ann_model").prop("files")[0].path);
        let modelPath = $("#upload_ann_model").prop("files")[0].path.split("\\").join("\\\\");
        vscode.postMessage(JSON.stringify({"start_ann_conversion":modelPath}));
    });
    $("#ann_convert_snn_simulate").click(function(){
        // 参数调整后的ANN转为SNN并在模拟器上运行
        console.log("Convert ANN to SNN and simulate on brain2 based.");
        anime({
            targets:"#circle4",
            backgroundColor:["rgb(14, 18, 219)", "rgb(50, 205, 50)"],
            easing:"easeInOutQuad",
            duration:1000,
            loop:true
        });
        vscode.postMessage(JSON.stringify({"start_simulate_from_ann":"start"}));
    });
    window.addEventListener("message",event=>{
        console.log("event data="+event.data);
        recvObj = JSON.parse(event.data);
        if(recvObj.stage1Data){
            console.log("receiving stage 1 data");
            let prevContent = $("#annOutput").html();
            prevContent += "<br/>"+recvObj.stage1Data.toString().split("\r\n").join("<br/>");
            $("#annOutput").html(prevContent);
            $("#annOutput").animate({scrollTop: $("#annOutput").get(0).scrollHeight},1);
            anime.remove("#circle2");
            anime({
                targets:"#circle2",
                backgroundColor:["rgb(50, 205, 50)","rgb(14, 18, 219)"],
                easing:'easeInOutQuad',
                duration:1000,
                loop:false
            });
            setTimeout(() => {
                anime.remove("#circle2");
            }, 1500);
        }else if(recvObj.stage2Data){
            console.log("Receive stage2 data.");
            let prevContent = $("#annOutput").html();
            prevContent += "<br/>"+recvObj.stage2Data.toString().split("\r\n").join("<br/>");
            $("#annOutput").html(prevContent);
            $("#annOutput").animate({scrollTop:$("#annOutput").get(0).scrollHeight},1);
            anime.remove("#circle3");
            anime({
                targets:"#circle3",
                backgroundColor:["rgb(14, 18, 219)","rgb(50, 205, 50)"],
                easing:"easeInOutQuad",
                duration:1000,
                loop:false
            });
            setTimeout(() => {
                anime.remove("#circle3");
            }, 1500);
        }else if(recvObj.convertedSNNSimu){
            console.log("Receive SNN built from ANN simulation output.");
            let prevContent = $("#annOutput").html();
            prevContent += "<br/>"+recvObj.convertedSNNSimu.toString().split("\r\n").join("<br/>");
            $("#annOutput").html(prevContent);
            $("#annOutput").animate({scrollTop:$("#annOutput").get(0).scrollHeight},1);
            anime.remove("#circle4");
            anime({
                targets:"#circle4",
                backgroundColor:["rgb(14, 18, 219)","rgb(50, 205, 50)"],
                easing:"easeInOutQuad",
                duration:1000,
                loop:false
            });
            setTimeout(() => {
                anime.remove("#circle4");
            }, 1500);
        }
    });
</script>

</html>