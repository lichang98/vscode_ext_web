<!DOCTYPE html>
<html style="height: 640px;width: 100%;">

<head>
  <meta charset="UTF-8">
  <title>SNN模型</title>
</head>

<body class="dark-mode" style="height: 100%;width: 100%;white-space: nowrap;overflow: auto;">

  <div class="loading-div">
    <div class="container"  style="margin-left: calc(50vw - 5px);">
      <div class="ispinner ispinner-large">
        <div class="ispinner-blade"></div>
        <div class="ispinner-blade"></div>
        <div class="ispinner-blade"></div>
        <div class="ispinner-blade"></div>
        <div class="ispinner-blade"></div>
        <div class="ispinner-blade"></div>
        <div class="ispinner-blade"></div>
        <div class="ispinner-blade"></div>
      </div>
    </div>
    <!-- <i class="fa fa-spinner fa-pulse fa-3x fa-fw" style="display: block;margin-left: 50vw;color: #333;"></i> -->
    <span style="color: #333;height: 50px;width: 120px;margin-left: calc(50vw - 20px);margin-top: -70px;display: block;"><font style="color: #333;font-weight: bolder;">数据信息加载中...</font></span>
  </div>

    <div style="height: 500px;margin-top: -5px;">
      <div style="height: 460px;width: 740px;display: inline-block;vertical-align: top;background: rgba(238,238,238,0.4);">
        <div style="text-align: center;"><font style="font-family: SourceHanSansCN-Normal;
          font-size: 20px;
          color: #333333;
          letter-spacing: 1.14px;">ANN-SNN模型对应关系图</font></div>
        <div id="sangky_chart" style="width: 700px;height: 400px;display: inline-block;margin-left: 50px;overflow-y: auto;overflow-x: hidden;"></div>
      </div>
      <!--权重分布图-->
      <div style="height: 460px;width: 770px;display: inline-block;vertical-align: top;background: rgba(238,238,238,0.4);">
          <div id="model_layers_vis_tab_caption" style="text-align: center;"><font style="font-family: SourceHanSansCN-Normal;
            font-size: 20px;
            color: #333333;
            letter-spacing: 1.14px;">脉冲神经网络权重分布</font></div>
              <div style="margin-left: 300px;text-align: center;width: 200px;">
                <label for="select_wt_layer"><font style="font-family: SourceHanSansCN-Normal;font-weight: normal;
                    font-size: 16px;
                    color: #333333;
                    letter-spacing: 0.91px;">选择连接</font></label>
                <select class="form-control" id="select_wt_layer">
                </select>
            </div>
          <div id="weight_dist_chart" style="width: 700px;height: 360px;margin-left: 40px;margin-top: 10px;"></div>
      </div>
    </div>

    <div style="height: 400px;margin-top: -25px;">
        <!-- SNN神经元信息 -->
        <div style="display: inline-block;background: rgba(238,238,238,0.4); height: 400px;width: 740px;">
            <div id="model_layers_vis_tab_caption" style="text-align: center;"><font style="font-family: SourceHanSansCN-Normal;
              font-size: 20px;
              color: #333333;
              letter-spacing: 1.14px;">各神经元组详细信息</font></div>
            <table id="snn_neurons_table" style="margin-left:80px;border: solid 3px #D6D6D6;width: 600px;">
                <caption class="white-text" style="caption-side: top;text-align: center;"></caption>
                <thead>
                  <tr style="margin-top: 15px;border: solid 2px #D6D6D6;color: #333;">
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">神经元组</td>
                    <!-- <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">神经元个数</td>
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">求解方法</td> -->
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">电压阈值</td>
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">神经元类型</td>
                  </tr>
                  <!-- 动态加载 -->
                </thead>
            </table>
        </div>

        <div style="display: inline-block;background: rgba(238,238,238,0.4);height: 400px;width: 750px;">
          <div style="text-align: center;"><font style="font-family: SourceHanSansCN-Normal;
            font-size: 20px;
            color: #333333;
            letter-spacing: 1.14px;">层连接权重统计</font></div>
          <table id="snn_layer_wt_table" style="border: solid 3px #D6D6D6;width: 600px;margin-left: 60px;">
            <caption class="white-text" style="caption-side: top;text-align: center;"></caption>
            <thead>
              <tr style="margin-top: 15px;border: solid 2px #D6D6D6;color: #333;">
                <td style="width: 80px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                font-size: 16px;
                color: #666666;padding-top: 12px; padding-bottom: 12px;">连接</td>
                <td style="width: 80px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                font-size: 16px;
                color: #666666;padding-top: 12px; padding-bottom: 12px;">均值</td>
                <td style="width: 80px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                font-size: 16px;
                color: #666666;padding-top: 12px; padding-bottom: 12px;">方差</td>
              </tr>
            </thead>
          </table>
        </div>

        <!-- <div style="height: 400px;margin-top: 20px;display: inline-block;background: rgba(238,238,238,0.4);width: 500px;">
            <div id="model_layers_vis_tab_caption" style="text-align: center;"><font style="font-family: SourceHanSansCN-Normal;
              font-size: 20px;
              color: #333333;
              letter-spacing: 1.14px;">脉冲神经网络突触连接信息</font></div>
            <table id="layer_conns_table" style="margin-left:60px;border: solid 3px #D6D6D6;width: 400px;">
                <caption class="white-text" style="caption-side: top;text-align: center;"></caption>
                <thead>
                  <tr style="margin-top: 15px;border: solid 2px #D6D6D6;color: #333;">
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">突触连接编号</td>
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">连接稠密度</td>
                    <td style="width: 100px;text-align: center;border: solid 2px #D6D6D6;background: #EEEEEE;font-family: SourceHanSansCN-Medium;
                    font-size: 16px;
                    color: #666666;padding-top: 12px; padding-bottom: 12px;">平均连接个数</td>
                  </tr>
                   动态加载 -->
                </thead>
            </table>
      </div>
</body>
<style>

.titlebar {
  -webkit-user-select: none;
  -webkit-app-region: drag;
}

.titlebar-button {
  -webkit-app-region: no-drag;
}

body {
  padding: 25px;
  background-color: rgb(251, 255, 255);
  color: white;
  font-size: 25px;
}

.dark-mode {
  background-color: rgb(249, 251, 252);
  color: white;
}


  @font-face {
    font-family: 'Material Icons';
    font-style: normal;
    font-weight: 400;
    src: local('Material Icons'), local('MaterialIcons-Regular'), url(https://fonts.gstatic.com/s/materialicons/v7/2fcrYFNaTjcS6g4U3t-Y5ZjZjT5FdEJ140U2DJYC3mY.woff2) format('woff2');
  }

  .material-icons {
    font-family: 'Material Icons';
    font-weight: normal;
    font-style: normal;
    font-size: 24px;
    line-height: 1;
    text-transform: none;
    display: inline-block;
    -webkit-font-feature-settings: 'liga';
    -webkit-font-smoothing: antialiased;
  }

  .loading-div {
      width: calc(100vw);
      height: calc(100vh);
      display: table-cell;
      vertical-align: middle;
      color: #555;
      overflow: hidden;
      text-align: center;
  }
  .loading-div::before {
      display: inline-block;
      vertical-align: middle;
  } 

.container {
  position: relative;
  display: inline-block;
  width: 100px;
  height: 100px;
  margin: 15px;
  box-sizing: border-box;
}
.container:last-child {
  padding: 31.5px;
}
.container::after {
  position: absolute;
  width: 100px;
  height: 60px;
  left: 0;
  bottom: -30px;
  line-height: 30px;
  text-align: center;
}
.container:last-child::after {
  content: 'large';
}
#sangky_chart svg {
  width: 140%;
  height: 140%;
}
</style>
<!-- Compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" href="http://localhost:6003/css/font-awesome.min.css">
<link rel="stylesheet" media="all" href="http://localhost:6003/css/ispinner.prefixed.css" />
<link href="https://cdn.bootcdn.net/ajax/libs/jointjs/3.3.1/joint.css" rel="stylesheet">

<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.8.0/echarts-en.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/backbone.js/1.4.0/backbone.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/jointjs/3.3.1/joint.js"></script>

<script>
const vscode = acquireVsCodeApi();
      $(document).ready(function(){
          vscode.postMessage(JSON.stringify({"ready": true}));
          window.addEventListener("message", function(evt){
            console.log("SNN 模型可视化接收到extension 消息: ");
              const data = JSON.parse(evt.data);
              if(data.snn_info){
                  var infos =JSON.parse(data.snn_info);
                  console.log("显示snn 基本信息......");
                  // 构建neurons info 表格
                  var neurons_info = infos.neurons_info;
                  var neurons_table = document.getElementById("snn_neurons_table");
                  for(var i=0;i<neurons_info.length;++i){
                      var line = document.createElement("tr");
                      line.style = "margin-top: 15px;border: solid 3px #D6D6D6;color: #333;"
                      var col_1 = document.createElement("td");
                      col_1.style = "text-align:center; padding-right:15px; font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      if (i == 0) {
                        col_1.innerText = "input";
                      } else if (i == neurons_info.length - 1) {
                        col_1.innerText = "out";
                      } else {
                        col_1.innerText = "layer_"+neurons_info[i].idx;
                      }
                      // col_1.innerText = neurons_info[i].idx;

                      // var col_2 = document.createElement("td");
                      // col_2.style = "border: solid 3px #D6D6D6;text-align:right; padding-right:15px;;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      // col_2.innerText = neurons_info[i].neuron_count;

                      // var col_3 = document.createElement("td");
                      // col_3.style = "border: solid 3px #D6D6D6;padding-left:10px;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      // col_3.innerText = neurons_info[i].method;

                      var col_4 = document.createElement("td");
                      col_4.style = "border: solid 3px #D6D6D6;text-align:center; padding-right:15px;;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      col_4.innerText = neurons_info[i].vthresh;

                      var col5 = document.createElement("td");
                      col5.style = "border: solid 3px #D6D6D6;text-align:center; padding-right:15px;;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                      col5.innerText = "IF";


                      line.appendChild(col_1);
                      // line.appendChild(col_2);
                      // line.appendChild(col_3);
                      line.appendChild(col_4);
                      line.appendChild(col5);

                      neurons_table.appendChild(line);
                  }
                  // 构建突触表格
                  // var synaps_info = infos.layer_conns;
                  // var synaps_table = document.getElementById("layer_conns_table");
                  // for(var i=0;i<synaps_info.length;++i){
                  //     var line = document.createElement("tr");
                  //     line.style = "margin-top: 15px; border: solid 3px #D6D6D6; color:#333;";
                  //     var col_1 = document.createElement("td");
                  //     col_1.style = "text-align:center; padding-right:15px;border: solid 3px #D6D6D6;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                  //     col_1.innerText = synaps_info[i].idx + "-"+(synaps_info[i].idx+1);

                  //     var col_2 = document.createElement("td");
                  //     col_2.style = "border: solid 3px #D6D6D6;text-align:right; padding-right:15px;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                  //     col_2.innerText = synaps_info[i].ratio;

                  //     var col_3 = document.createElement("td");
                  //     col_3.style = "border: solid 3px #D6D6D6;text-align:right; padding-right:15px;font-family: ArialMT;font-size: 14px;color: #333333;padding-top: 12px; padding-bottom: 12px;";
                  //     col_3.innerText = synaps_info[i].avg_conn;

                  //     line.appendChild(col_1);
                  //     line.appendChild(col_2);
                  //     line.appendChild(col_3);
                  //     synaps_table.appendChild(line);
                  // }

                  // 绘制权重分布图
                  console.log("权重数据："+infos.layers_weights.wt_label);
                  console.log("数值:"+infos.layers_weights.wt_count);
                  console.log("浮点权重数据："+infos.layer_flt_weights.wt_label);
                  console.log("数值："+infos.layer_flt_weights.wt_count);
                  // for(var i=0;i<infos.layers_weights.wt_count.length;++i){
                  //   if (infos.layers_weights.wt_count[i] > 0) {
                  //     infos.layers_weights.wt_count[i] = Math.log10(infos.layers_weights.wt_count[i]);
                  //   } else {
                  //     infos.layers_weights.wt_count[i] = 0;
                  //   }
                  // }
                  // for (var i = 0; i < infos.layer_flt_weights.wt_count.length;++i) {
                  //   if (infos.layer_flt_weights.wt_count[i] > 0) {
                  //     infos.layer_flt_weights.wt_count[i] = Math.log10(infos.layer_flt_weights.wt_count[i]);
                  //   } else {
                  //     infos.layer_flt_weights.wt_count[i] = 0;
                  //   }
                  // }

                  // 添加选项
                  let innerhtml4option = "";
                  for (let k = 0; k < infos.each_layer_wt_infos.wt_counts.length; ++k) {
                    if (k == 0){
                      innerhtml4option += "<option>input-->layer_1</option>";
                    } else if (k == infos.each_layer_wt_infos.wt_counts.length - 1){
                      innerhtml4option += "<option>layer_"+k+"-->out</option>"
                    } else {
                      innerhtml4option += "<option>layer_"+(k)+"-->layer_"+(k+1)+"</option>";
                    }
                  }
                  document.getElementById("select_wt_layer").innerHTML = innerhtml4option;
                  $("#select_wt_layer").change(()=>{
                    let select_which = $("#select_wt_layer").val();
                    if (select_which.indexOf("input") >=0){
                      var yaxis_max = Math.max(Math.ceil(Math.log10(Math.max(...infos.each_layer_wt_infos.flt_wt_counts[0]))), 
                                              Math.ceil(Math.log10(Math.max(...infos.each_layer_wt_infos.wt_counts[0]))))
                      display_weight_chart(infos.each_layer_wt_infos.flt_wt_labels[0], infos.each_layer_wt_infos.flt_wt_counts[0], 
                                infos.each_layer_wt_infos.wt_labels[0], infos.each_layer_wt_infos.wt_counts[0], yaxis_max);
                    } else if(select_which.indexOf("out") >=0){
                      var len_of_lay = infos.each_layer_wt_infos.flt_wt_labels.length - 1;
                      var yaxis_max = Math.max(Math.ceil(Math.log10(Math.max(...infos.each_layer_wt_infos.flt_wt_counts[len_of_lay]))), 
                                              Math.ceil(Math.log10(Math.max(...infos.each_layer_wt_infos.wt_counts[len_of_lay]))));
                      display_weight_chart(infos.each_layer_wt_infos.flt_wt_labels[len_of_lay], infos.each_layer_wt_infos.flt_wt_counts[len_of_lay], 
                                infos.each_layer_wt_infos.wt_labels[len_of_lay], infos.each_layer_wt_infos.wt_counts[len_of_lay], yaxis_max);
                    } else {
                      var idx = parseInt(select_which.substr(select_which.lastIndexOf("_") + 1)) - 1;
                      var yaxis_max = Math.max(Math.ceil(Math.log10(Math.max(...infos.each_layer_wt_infos.flt_wt_counts[idx]))),
                                              Math.ceil(Math.log10(Math.max(...infos.each_layer_wt_infos.wt_counts[idx]))));
                      display_weight_chart(infos.each_layer_wt_infos.flt_wt_labels[idx], infos.each_layer_wt_infos.flt_wt_counts[idx], 
                                infos.each_layer_wt_infos.wt_labels[idx], infos.each_layer_wt_infos.wt_counts[idx], yaxis_max);
                    }
                  });
                  var yaxis_max = Math.max(Math.ceil(Math.log10(Math.max(...infos.each_layer_wt_infos.flt_wt_counts[0]))),
                                          Math.ceil(Math.log10(Math.max(...infos.each_layer_wt_infos.wt_counts[0]))));
                  display_weight_chart(infos.each_layer_wt_infos.flt_wt_labels[0], infos.each_layer_wt_infos.flt_wt_counts[0], 
                                infos.each_layer_wt_infos.wt_labels[0], infos.each_layer_wt_infos.wt_counts[0], yaxis_max);
                  // display_weight_chart(infos.layer_flt_weights.wt_label, infos.layer_flt_weights.wt_count,infos.layers_weights.wt_label, infos.layers_weights.wt_count);

                  // 仿真配置与结果表格
                  $("#simulate_vthresh").text(infos.extra_simu_info.simulate_vthresh);
                  $("#simulate_neuron_dt").text(infos.extra_simu_info.simulate_neuron_dt);
                  $("#simulate_synapse_dt").text(infos.extra_simu_info.simulate_synapse_dt);
                  $("#simulate_delay").text(infos.extra_simu_info.simulate_delay);
                  $("#simulate_dura").text(infos.extra_simu_info.simulate_dura);
                  $("#simulate_acc").text(infos.extra_simu_info.simulate_acc);


                  // 添加SNN各层权重信息
                  for(let i=0;i<infos.record_layers_wt_info.record_wts_avg.length;++i){
                    let table_line = document.createElement("tr");
                    table_line.style.marginTop = "15px";
                    table_line.style.border = "solid 3px #D6D6D6";
                    table_line.style.color = "#333";

                    let td_id = document.createElement("td");
                    // font-family: ArialMT;font-size: 14px;color: #333333;
                    td_id.style.fontSize = "14px";
                    td_id.style.fontFamily = "ArialMT";
                    td_id.style.color = "#333333";
                    td_id.style.width = "120px";
                    td_id.style.border = "solid 3px #D6D6D6";
                    td_id.style.textAlign = "center";
                    td_id.style.paddingRight = "15px";
                    td_id.style.paddingTop = "12px";
                    td_id.style.paddingBottom = "12px";
                    // td_id.innerText = ""+i+"-"+(i+1);
                    if (i == 0) {
                      td_id.innerText = "input ---> "+"layer_"+(i+1);
                    } else if (i == infos.record_layers_wt_info.record_wts_avg.length - 1) {
                      td_id.innerText = "layer_"+i+" ---> "+"out";
                    } else {
                      td_id.innerText = "layer_"+(i)+" ---> layer_"+(i+1);
                    }
                    table_line.appendChild(td_id);

                    let td_avg = document.createElement("td");
                    td_avg.style.fontSize = "14px";
                    td_avg.style.fontFamily = "ArialMT";
                    td_avg.style.color = "#333333";
                    td_avg.style.width = "120px";
                    td_avg.style.border = "solid 3px #D6D6D6";
                    td_avg.style.textAlign = "right";
                    td_avg.style.paddingRight = "15px";
                    td_avg.style.paddingTop = "12px";
                    td_avg.style.paddingBottom = "12px";
                    td_avg.innerText = infos.record_layers_wt_info.record_wts_avg[i];
                    table_line.appendChild(td_avg);

                    let td_std = document.createElement("td");
                    td_std.style.fontSize = "14px";
                    td_std.style.fontFamily = "ArialMT";
                    td_std.style.color = "#333333";
                    td_std.style.width = "120px";
                    td_std.style.textAlign = "right";
                    td_std.style.paddingRight = "15px";
                    td_std.style.border = "solid 3px #D6D6D6";
                    td_std.style.paddingTop = "12px";
                    td_std.style.paddingBottom = "12px";
                    td_std.innerText = infos.record_layers_wt_info.record_wts_std[i];
                    table_line.appendChild(td_std);

                    document.getElementById("snn_layer_wt_table").appendChild(table_line);

                  }

                  // 显示模型框图
                  let origin_layer_names = infos.origin_layer_names;
                  console.log("origin_layer_names="+origin_layer_names);
                  var graph = new joint.dia.Graph;
                  var paper = new joint.dia.Paper({
                      el: document.getElementById('sangky_chart'),
                      model: graph,
                      width: 600,
                      height: 400,
                      gridSize: 1,
                      drawGrid: true,
                      background: {
                          color: 'rgba(238,238,238,0.4)'
                      }
                  });

                  var rect_tip = new joint.shapes.standard.Rectangle();
                  rect_tip.position(460, 180);
                  rect_tip.resize(120, 200);
                  rect_tip.attr({
                    body:{
                      fill:"rgb(255,248,220)"
                    },
                    label: {
                      text: joint.util.breakText("图例", {width: 80}),
                      fill: "black",
                      refY: "5%",
                      fontSize: 12
                    }
                  });
                  rect_tip.addTo(graph);

                  var rect_legend1 = new joint.shapes.standard.Rectangle();
                  rect_legend1.position(480,200);
                  rect_legend1.resize(80,30);
                  rect_legend1.attr({
                    body:{
                      fill: 'red'
                    },
                    label: {
                      text: "ANN层(删除)",
                      fill:"black",
                      fontSize:10
                    }
                  });
                  rect_legend1.addTo(graph);

                  var rect_legend2 = new joint.shapes.standard.Rectangle();
                  rect_legend2.position(480, 250);
                  rect_legend2.resize(80, 30);
                  rect_legend2.attr({
                    body: {
                      fill: '#FF9800'
                    },
                    label: {
                      text: "ANN层(前向融合)",
                      fill: "black",
                      fontSize: 10
                    }
                  });
                  rect_legend2.addTo(graph);
                  
                  var rect_legend3 = new joint.shapes.standard.Rectangle();
                  rect_legend3.position(480, 300);
                  rect_legend3.resize(80, 30);
                  rect_legend3.attr({
                    body: {
                      fill: 'gray'
                    },
                    label: {
                      text: "ANN层(转换)",
                      fill: 'black',
                      fontSize: 10
                    }
                  });
                  rect_legend3.addTo(graph);

                  var rect_legend4 = new joint.shapes.standard.Rectangle();
                  rect_legend4.position(480, 350);
                  rect_legend4.resize(80, 30);
                  rect_legend4.attr({
                    body: {
                      fill: 'green'
                    },
                    label: {
                      text: "SNN层",
                      fill: 'black',
                      fontSize: 10
                    }
                  });
                  rect_legend4.addTo(graph);

                  let prev_rect = undefined;
                  let idx4layer = 0;
                  let k_pos = 0;
                  let extra_idx = -1;
                  for (let k = 0; k < origin_layer_names.length; ++k) {
                    var layer_idx = "layer_"+idx4layer;
                    if (k === 0) {
                      layer_idx = "input";
                    } else if (k === origin_layer_names.length - 1) {
                      layer_idx = "out";
                    }
                    var rect = new joint.shapes.standard.Rectangle();
                    rect.position(40, 40 * k_pos + 20);
                    rect.resize(120, 20);
                    rect.attr({
                        body: {
                            fill: 'gray'
                        },
                        label: {
                            text: origin_layer_names[k],
                            fill: 'white'
                        }
                    });
                    var rect_snn_ctpt = new joint.shapes.standard.Rectangle();
                    var is_rect_snn_ctpt_added = false;
                    if (origin_layer_names[k] == "Activation" ||
                        origin_layer_names[k] == "Dropout" || origin_layer_names[k] == "Flatten") {
                        rect.attr("body/fill", "red");
                        rect.attr("label/text", origin_layer_names[k]);
                    } else if (origin_layer_names[k] == "BatchNormalization") {
                      rect.attr("body/fill", "#FF9800");
                      rect.attr("label/text", origin_layer_names[k]);
                    }
                    else {
                      idx4layer += 1;
                      // 对应snn层/input/out layer
                      rect_snn_ctpt.position(200, 40 * k_pos + 20);
                      rect_snn_ctpt.resize(120, 20);
                      rect_snn_ctpt.attr({
                        body: {
                          fill: "green"
                        },
                        label: {
                          text: "",
                          fill:'white'
                        }
                      });
                      if (k === 0) {
                        rect_snn_ctpt.attr("label/text", "input");
                      } else if (k === origin_layer_names.length - 1) {
                        rect_snn_ctpt.attr("label/text", "out");
                      } else {
                        rect_snn_ctpt.attr("label/text", ""+layer_idx);
                      }
                      is_rect_snn_ctpt_added = true;
                      // var rect_legend3 = new joint.shapes.standard.Rectangle();
                      // rect_legend3.position(40, 140);
                      // rect_legend3.resize(80, 30);
                      // rect_legend3.attr({
                      //   body: {
                      //     fill: 'gray'
                      //   },
                      //   label: {
                      //     text: "转换",
                      //     fill: 'black'
                      //   }
                      // });
                      // rect_legend3.addTo(graph);
                    }
                    rect.addTo(graph);
                    if (is_rect_snn_ctpt_added) {
                      rect_snn_ctpt.addTo(graph);
                      var link_ann_snn_contpt = new joint.shapes.standard.Link();
                      link_ann_snn_contpt.attr("line/strokeDasharray",1+' '+1);
                      link_ann_snn_contpt.attr("line/stroke", '#7DCEA0');
                      link_ann_snn_contpt.source(rect);
                      link_ann_snn_contpt.target(rect_snn_ctpt);
                      link_ann_snn_contpt.addTo(graph);
                    }

                    if (prev_rect !== undefined) {
                      var link = new joint.shapes.standard.Link();
                      link.source(prev_rect);
                      link.target(rect);
                      link.addTo(graph);
                    }
                    prev_rect = rect;
                    if (origin_layer_names[k] === "Conv2D") {
                      extra_idx++;
                        if (infos.layer_extras[k] === "relu") {
                          k_pos++;
                          var rect_extra = new joint.shapes.standard.Rectangle();
                          rect_extra.position(40, 40 * k_pos + 20);
                          rect_extra.resize(120, 20);
                          rect_extra.attr({
                            body: {
                              fill: "red"
                            },
                            label: {
                              text: "Activation",
                              fill: 'white'
                            }
                          });
                          rect_extra.addTo(graph);
                          var link_extra = new joint.shapes.standard.Link();
                          link_extra.source(prev_rect);
                          link_extra.target(rect_extra);
                          link_extra.addTo(graph);

                          prev_rect = rect_extra;
                      }
                    }
                    k_pos++;
                  }

                  $(".loading-div").hide(); // 隐藏加载提示

            //       <table id="snn_layer_wt_table" style="width: 320px;">
            // <caption class="white-text" style="caption-side: top;text-align: center;"></caption>
            // <thead>
            //   <tr style="margin-top: 15px;border: solid 3px;">
            //     <td style="font-size: medium;font-weight: bold;width: 120px;padding-left: 10px;">layer编号</td>
            //     <td style="font-size: medium;font-weight: bold;width: 120px;">权重均值</td>
            //     <td style="font-size: medium;font-weight: bold;width: 120px;">权重方差</td>
            //   </tr>
            // </thead>

    //         "record_layers_wt_info":{
    //     "record_wts_avg":record_layers_wt_avg,
    //     "record_wts_std":record_layers_wt_std
    // }

                  // // SNN模型简图
                  // let sanky_data=new Array();
                  // let sanky_links=new Array();
                  // for(let i=0;i<infos.layer_conns.length+1;++i){
                  //     sanky_data.push({"name": "layer_"+i});
                  // }
                  // for(let i=0;i<infos.layer_conns.length;++i){
                  //     sanky_links.push({"source":"layer_"+i, "target":"layer_"+(i+1), "value": infos.layer_conns[i].ratio, "lineStyle":{"color": "#c23531"}});
                  // }
                //   console.log("Display sanky graph, sanky_data="+sanky_data[0]['name']);
                  // console.log("Display sanky links, ="+sanky_links['0']['value']);
                  // display_snn_model_sanky(sanky_data, sanky_links);
              }else if(data.snn_map){
                // console.log("显示SNN 结构图.....");
                // net_structure_show("sangky_chart", data.snn_map);

              }
          });
      });

      function display_weight_chart(flt_label_names, flt_label_counts,label_names, label_counts, yaxis_max){
        var ytick_max = Math.pow(10, yaxis_max);
        console.log("interval="+yaxis_max+", ytick_max="+ytick_max);
          var opt = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: '#999'
                        }
                    }
                },
                legend: {
                  data: ['浮点数权重', "定点数权重"],
                  textStyle: {
                    color: '#999'
                  }
                },
                xAxis: [
                  {
                      type: 'category',
                      data: flt_label_names,
                      name:"浮点权重",
                      nameLocation: 'center',
                      nameGap : 30,
                      nameTextStyle:{
                        color:"#999999",
                        fontFamily: 'SourceHanSansCN-Normal',
                        fontSize: '14px',
                      },
                      axisLabel:{
                        textStyle:{
                          color:"#999999"
                        },
                        fontFamily: 'SourceHanSansCN-Normal',
                        fontSize: '14px',
                    },
                    show:true,
                    position: 'top'
                  },
                  {
                      type: 'category',
                      data: label_names,
                      name:"定点权重",
                      nameLocation: 'center',
                      nameGap: 30,
                      nameTextStyle:{
                        color:"#999999",
                        fontFamily: 'SourceHanSansCN-Normal',
                        fontSize: '14px',
                      },
                      axisLabel:{
                        textStyle:{
                          color:"#999999"
                        },
                        fontFamily: 'SourceHanSansCN-Normal',
                        fontSize: '14px',
                    },
                    position: 'bottom'
                  }
                ],
                yAxis: [
                 {
                    type: 'log',
                    min: 1,
                    max: ytick_max,
                    interval: yaxis_max,
                    logBase: 10,
                    name:"浮点权重数量",
                    nameLocation: 'center',
                    nameGap: 40,
                    nameTextStyle:{
                      color:"#999999",
                      fontFamily: 'SourceHanSansCN-Normal',
                      fontSize: '14px',
                    },
                    scale:true,
                    axisLabel: {
                        formatter: '{value}',
                        textStyle:{
                          color:"#999999"
                        },
                        fontFamily: 'SourceHanSansCN-Normal',
                        fontSize: '14px',
                    },
                    inverse:false
                  },
                  {
                    type: 'log',
                    min: 1,
                    max: ytick_max,
                    interval: yaxis_max,
                    logBase: 10,
                    name:"定点权重数量",
                    nameLocation: 'center',
                    nameGap: 40,
                    nameTextStyle:{
                      color:"#999999",
                      fontFamily: 'SourceHanSansCN-Normal',
                      fontSize: '14px',
                    },
                    scale:true,
                    axisLabel: {
                        formatter: '{value}',
                        textStyle:{
                          color:"#999999"
                        },
                        fontFamily: 'SourceHanSansCN-Normal',
                        fontSize: '14px',
                    },
                    inverse:false
                  },
                ],
                series: [{
                    data: flt_label_counts,
                    type: 'bar',
                    name: "浮点数权重",
                    xAxisIndex:0,
                    YAxisIndex:0,
                    itemStyle: {
                      normal: {
                        color: "rgba(237, 58, 18, 0.47)"
                      }
                    }
                },
                {
                  data: label_counts,
                  type: 'bar',
                  name: "定点数权重",
                  xAxisIndex:1,
                  yAxisIndex:1,
                  itemStyle: {
                    normal: {
                      color: "rgba(8, 41, 150, 0.3)"
                    }
                  }
                }
              ]
            };
            var weights_chart = echarts.init(document.getElementById("weight_dist_chart"));
            weights_chart.setOption(opt);
      }

      function display_snn_model_sanky(chart_data, chart_links){
          let option={
            series: {
                    type: 'sankey',
                    layout: 'none',
                    emphasis: {
                        focus: 'adjacency'
                    },
                    data: chart_data,
                    links: chart_links
                }
          };

          var sanky_chart_ = echarts.init(document.getElementById("sangky_chart"));
          sanky_chart_.setOption(option);
      }

      function net_structure_show(elementId, map_file_url) {
                // 基于准备好的dom，初始化echarts实例
                var myChart = echarts.init(document.getElementById(elementId)); //初始化
                console.log("SNN 结构 div 显示 loading...");
                myChart.showLoading();
                $.get(map_file_url, function (map_file) {
                    var node_data = map_file.data;
                    var node_link = map_file.links;
                    var node_class = map_file.layers;
                    var ratios = map_file.ratio;
                    var num = map_file.nums;
                    console.log("加载完毕map json 数据....");
                    console.log("ratios = "+ratios);
                    var categories = [];
                    for (var i = 0; i < node_class.length; i++) {
                        categories[i] = {
                            name: node_class[i],
                        };
                    }
                    console.log("categories finished...");
                    // 指定图表的配置项和数据
                    let option = {
                        title: {
                            show: true,
                            // text: 'Network Structure Diagram',
                            text: 'ratio     1 : ' + ratios,
                            textStyle:{
                                color:"#333333",
                                fontFamily: 'SourceHanSansCN-Normal',
                                fontSize: '14px',
                            },
                            bottom: '3%',
                            left: 'center'
                        },
                        tooltip: {}, //提示信息
                        legend: {   //图例组件
                            // top: "0%",   //距离顶部5%
                            // bottom: "88%",
                            // left: "5%",
                            orient:'vertical',
                            x:'left',
                            y:'center',
                            data: node_class,
                            formatter: function (name) {
                                var neuron_num;
                                for (var i = 0; i < node_class.length; i++) {
                                    if (node_class[i] === name) {
                                        neuron_num = num[i];
                                        break;
                                    }
                                }
                                // var arr = [
                                //     name,
                                //     '(' + neuron_num + ')'
                                // ];
                                var arr = [
                                    '{a|' + name + '}',
                                    '{b|(' + neuron_num + ')}'
                                ];
                                return arr.join('\\n');
                            },
                            textStyle: {
                                rich: {
                                    a: {
                                        fontSize: 14,
                                        verticalAlign: 'top',
                                        align: 'center',
                                        padding: [0, 0, 5, 0],
                                        color:"#333333",
                                        fontFamily: 'SourceHanSansCN-Normal',
                                        letterSpacing: '0.8px'
                                    },
                                    b: {
                                        fontSize: 8,
                                        align: 'center',
                                        padding: [0, 10, 0, 0],
                                        lineHeight: 25,
                                        color:"#333333",
                                        fontFamily: 'SourceHanSansCN-Normal',
                                        letterSpacing: '0.8px'
                                    }
                                },
                                color:"#333333",
                                fontFamily: 'SourceHanSansCN-Normal',
                                fontSize: '14px',
                            }
                        },
                        animationDuration: 1500,
                        animationEasingUpdate: "quinticInOut",
                        series: [ //系列列表
                            {

                                name: "Les Miserables",  //系列名称
                                type: "graph",   //系列图表类型  ——  关系图
                                // layout: "circular",
                                // top: "15%",
                                // bottom: "8%",
                                symbolSize: 5,  //图元的大小
                                data: node_data,
                                links: node_link,
                                roam: true,
                                // focusNodeAdjacency: true,
                                categories: categories,
                            },
                        ],
                    };

                    console.log("option init finished....");
                    // 使用刚指定的配置项和数据显示图表。
                    myChart.hideLoading();
                    myChart.setOption(option); //使用json
                });
            }
</script>

</html>
