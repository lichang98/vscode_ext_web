<!DOCTYPE html>
<html style="height: 640px;width: 100%;">

<head>
  <meta charset="UTF-8">
  <title>模型转换器</title>
</head>

<body class="dark-mode" style="height: 100%;width: 100%;white-space: nowrap;overflow: auto;">

    <div style="margin-top: 20px;display: block;">

        <div style="background: rgba(238,238,238);width: 350px;height: 350px;display: inline-block;">
          <div>
            <div id="model_layers_vis_tab_caption" style="font-size: large;font-weight: bold;text-align: center;"><font style="color: #333;font-weight: bold;">仿真配置结果评估</font></div>
            <table id="layer_conf_val" style="width: 260px;margin-left:40px;margin-top: 70px;border: solid 3px #D6D6D6;">
                <caption class="white-text" style="caption-side: top;text-align: center;"></caption>
                <tr style="height: 25px; border: solid 2px #D6D6D6;color: #333;">
                  <td style="font-size: medium;font-weight: bold;padding-left: 15px;border: solid 2px #D6D6D6;">膜电压阈值</td>
                  <td id="simulate_vthresh"></td>
                </tr>
                <tr style="height: 25px;border: solid 2px #D6D6D6;color: #333;"">
                  <td style="font-size: medium;font-weight: bold;padding-left: 15px;border: solid 2px #D6D6D6;">神经元时间步长</td>
                  <td id="simulate_neuron_dt"></td>
                </tr>
                <tr style="height: 25px;border: solid 2px #D6D6D6;color: #333;"">
                  <td style="font-size: medium;font-weight: bold;padding-left: 15px;border: solid 2px #D6D6D6;">突触时间步长</td>
                  <td id="simulate_synapse_dt"></td>
                </tr>
                <tr style="height: 25px;border: solid 2px #D6D6D6;color: #333;"">
                  <td  style="font-size: medium;font-weight: bold;padding-left: 15px;border: solid 2px #D6D6D6;">延迟</td>
                  <td id="simulate_delay"></td>
                </tr>
                <tr style="height: 25px;border: solid 2px #D6D6D6;color: #333;"">
                  <td style="font-size: medium;font-weight: bold;padding-left: 15px;border: solid 2px #D6D6D6;">仿真时长</td>
                  <td id="simulate_dura"></td>
                </tr>
                <tr style="height: 25px;border: solid 2px #D6D6D6;color: #333;"">
                  <td style="font-size: medium;font-weight: bold;color: rgb(161, 11, 247);padding-left: 15px;border: solid 2px #D6D6D6;">准确率</td>
                  <td id="simulate_acc" style="color: rgb(161, 11, 247);"></td>
                </tr>    
            </table>
          </div>
        </div>

        <div style="background: rgba(238,238,238);width: 350px;height: 350px;display: inline-block;">
          <div style="font-size: large;font-weight: bold;text-align: center;margin-left: 40px;"><font style="color: #333;font-weight: bold;">放电次数均值方差统计</font></div>
          <table id="snn_layers_spike_table" style="width: 280px;margin-left:40px;margin-top: 70px;border: solid 3px #D6D6D6;">
            <caption class="white-text" style="caption-side: top;text-align: center;"></caption>
            <tr style="height: 25px; border: solid 2px #D6D6D6;color: #333;">
              <td style="font-size: medium;font-weight: bold;padding-left: 15px;border: solid 2px #D6D6D6;">层编号</td>
              <td style="font-size: medium;font-weight: bold;padding-left: 15px;border: solid 2px #D6D6D6;">放电次数均值</td>
              <td style="font-size: medium;font-weight: bold;padding-left: 15px;border: solid 2px #D6D6D6;">放电次数方差</td>
            </tr>
          </table>
        </div>

        <div style="background: rgba(238,238,238);width: 500px;height: 350px;display: inline-block;">
          <div>
            <div id="neurons_v_out_div" style="font-size: large;font-weight: bold;text-align: center;"><font style="color: #333;font-weight: bold;">神经元放电</font></div>
            <div style="width: 360px;margin-left: 40px;">
              <form class="form-horizontal" role="form">
                <div class="form-group">
                  <label class="control-label col-md-8" for="select_which_layer"><font style="color: #333;font-weight: bold;">选择神经元层</font></label>
                  <div class="col-md-4">
                    <select class="form-control" id="select_which_layer">
                      <option>输入层</option>
                      <option>输出层</option>
                  </select>
                  </div>
                </div>
              </form>
            </div>
            <div id="neurons_v_chart" style="width: 460px;height: 240px;margin-left: 40px;margin-top: 40px;"></div>
          </div>
        </div>
    </div>
    <div style="margin-top: 5px;display: block;">
        <div style="display: inline-block;width: 610px;height: 550px;background: rgba(238,238,238)">
          <div id="model_input_spike_cap" style="font-size: large;font-weight: bold;text-align: center;"><font style="color: #333;font-weight: bold;">脉冲神经网络输入层脉冲</font></div>
          <div id="input_spike_charts" style="width: 460px;height: 320px;margin-left: 70px;display: inline-block;margin-top: 40px;"></div>
          <ul id="input_spike_sample_imgs_ul" style="height: 60px;width: 460px;overflow: auto; white-space: nowrap;display: block;margin-left: 55px;margin-top: 20px;">
          </ul>
        </div>
        <div style="width: 590px;height: 550px;display: inline-block;margin: left 20px;vertical-align: top;background: rgba(238,238,238)">
            <div id="model_layers_vis_tab_caption" style="font-size: large;font-weight: bold;text-align: center;"><font style="color: #333;font-weight: bold;">脉冲神经网络输出层脉冲</font></div>
            <span style="font-size: smaller;margin-left: 160px;color: rgb(133, 4, 255);">红色标记图像为输出层预测错误</span>
            <div id="model_layers_vis_tab_caption" style="font-size: small;font-weight: bold;text-align: center;"><font style="color: #333;font-weight: bold;">统计计数</font></div>
            <table id="spike_out_count_table" style="margin-left: 100px;border: solid 3px #D6D6D6;color: #333;">
                <tr id="out_labels" style="border: solid 2px #D6D6D6;">
                </tr>
                <tr id="out_counts_tr" style="border: solid 2px #D6D6D6;">
                </tr>
            </table>
            <div id="spike_charts" style="width: 460px;height: 320px;margin-left: 70px;display: inline-block;"></div>
            <ul id="sample_imgs_ul" style="height: 100px;width: 460px;overflow: auto; white-space: nowrap;display: block;margin-left: 80px;">
            </ul>
        </div>
    </div>
</body>
<style>

.titlebar {
  -webkit-user-select: none;
  -webkit-app-region: drag;
}

.titlebar-button {
  -webkit-app-region: no-drag;
}

body {
  padding: 25px;
  background-color: rgb(251, 255, 255);
  color: white;
  font-size: 25px;
}

.dark-mode {
  background-color: rgb(249, 251, 252);
  color: white;
}

  @font-face {
    font-family: 'Material Icons';
    font-style: normal;
    font-weight: 400;
    src: local('Material Icons'), local('MaterialIcons-Regular'), url(https://fonts.gstatic.com/s/materialicons/v7/2fcrYFNaTjcS6g4U3t-Y5ZjZjT5FdEJ140U2DJYC3mY.woff2) format('woff2');
  }

  .material-icons {
    font-family: 'Material Icons';
    font-weight: normal;
    font-style: normal;
    font-size: 24px;
    line-height: 1;
    text-transform: none;
    display: inline-block;
    -webkit-font-feature-settings: 'liga';
    -webkit-font-smoothing: antialiased;
  }
</style>
<!-- Compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">

<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdn.staticfile.org/echarts/5.0.1/echarts.min.js"></script>

<script>
  let prev_clicked_li = undefined;
  let prev_clicked_input_li = undefined;
  let need_red_img_li = new Array();

      $(document).ready(function(){
          window.addEventListener("message", function(evt){
            console.log("SNN 仿真接收到extension 消息");
            need_red_img_li.splice(0);
              const data = JSON.parse(evt.data);
              if(data.snn_info){
                  var infos =JSON.parse(data.snn_info);

                  var test_img_uls = document.getElementById("sample_imgs_ul");
                  var test_img_uris = infos.spikes.snn_test_imgs;
                  var test_img_spikes = infos.spikes.snn_test_spikes;
                  console.log("spiking img uris[0]"+test_img_uris[0]);
                  console.log("spiking spike infos[0]="+test_img_spikes[0].cls_names);
                  console.log("spike tuples[0]="+test_img_spikes[0].spike_tuples);

                  calc_need_red(test_img_spikes, test_img_uris);
                  console.log("call calc_need_red function finish, start for img uris...");
                  for(let i=0;i<test_img_uris.length;++i){
                    var img_li = document.createElement("li");
                    img_li.style.listStyle = "none";
                    img_li.style.display = "inline-block";
                    img_li.id = "img_li_"+i;
                    img_li.style.width = "53px";
                    img_li.style.height = "80px";
                    img_li.style.marginRight = "20px";
                    var img_tag = document.createElement("img");
                    img_tag.id = "sample_img_"+i;
                    img_tag.style.opacity = "0.5";
                    img_tag.style.display = "block";
                    img_tag.onclick = function(){
                      console.log("draw NO."+i+" img and spikes");
                      console.log("current click cls_names="+test_img_spikes[i].cls_names);
                      console.log("current click spike tuples="+test_img_spikes[i].spike_tuples);
                      if(prev_clicked_li !== undefined){
                        document.getElementById(prev_clicked_li).style.backgroundColor = "";
                      }
                      document.getElementById("img_li_"+i).style.backgroundColor = "chocolate";
                      prev_clicked_li = "img_li_"+i;
                      display_spike_scatter_chart(test_img_spikes[i].cls_names, test_img_spikes[i].spike_tuples);

                      // display counts in table
                      console.log("start display counts in table....");
                      let cls_idx = test_img_spikes[i].spike_tuples[0][0];
                      console.log("cls_idx="+cls_idx);
                      let curr_count=1;
                      let spike_counts = new Array();
                      for(let j=0;j<test_img_spikes[i].cls_names.length;++j){
                          spike_counts.push(0);
                      }
                      console.log("test_img_spikes[i].spike_tuples.length="+test_img_spikes[i].spike_tuples.length);
                      for(let j=1;j<test_img_spikes[i].spike_tuples.length;++j){
                          if(cls_idx === test_img_spikes[i].spike_tuples[j][0]){
                              curr_count = curr_count+1;
                          }else{
                              spike_counts[cls_idx] = curr_count;
                              curr_count=1;
                              cls_idx = test_img_spikes[i].spike_tuples[j][0];
                          }
                      }
                      console.log("--- calc finished.");
                      console.log("spike counts="+spike_counts);
                      spike_counts[cls_idx] = curr_count;
                      document.getElementById("out_labels").innerHTML = "";
                      let td_child = document.createElement("td");
                      td_child.innerText = "标签名称:";
                      td_child.style.width = "80px";
                      document.getElementById("out_labels").appendChild(td_child);

                      document.getElementById("out_counts_tr").innerHTML = '';
                      td_child = document.createElement("td");
                      td_child.innerText = "计数值:";
                      td_child.style.width = "80px";
                      document.getElementById("out_counts_tr").appendChild(td_child);

                      for(let j=0;j<spike_counts.length;++j){
                        let td_child = document.createElement("td");
                        td_child.innerText = spike_counts[j];
                        td_child.style.width = "33px";
                        document.getElementById("out_counts_tr").appendChild(td_child);

                        td_child = document.createElement("td");
                        td_child.innerText = test_img_spikes[i].cls_names[j];
                        td_child.style.width = "33px";
                        document.getElementById("out_labels").appendChild(td_child);
                      }

                      console.log("check spike_counts of "+i+", ="+spike_counts);
                      // mark reds
                      for(let k=0;k<need_red_img_li.length;++k){
                        if(prev_clicked_li === need_red_img_li[k]){
                          document.getElementById(need_red_img_li[k]).style.backgroundColor = "yellow";  
                        }else{
                          document.getElementById(need_red_img_li[k]).style.backgroundColor = "red";
                        }
                      }
                    }
                    img_tag.src = test_img_uris[i];
                    img_tag.style.width = "50px";
                    img_tag.style.height = "50px";

                    img_li.appendChild(img_tag);
                    test_img_uls.appendChild(img_li);

                    var label_span = document.createElement("span");
                    label_span.style.color = "#333";
                    console.log("图片 i="+i+", uri="+test_img_uris[i]);
                    // a.split("/")[5].split("_")[4].split(".")[0]
                    // label_span.innerText = "标签: "+test_img_uris[i].split("_")[5].split(".")[0];
                    label_span.innerText = "标签: "+test_img_uris[i].split("/")[5].split("_")[4].split(".")[0];
                    img_li.appendChild(label_span);
                  }

                  // 创建输入层脉冲激发图
                  for(let i=0;i<infos.spikes.snn_input_spikes.length;++i){
                    var input_img_li = document.createElement("li");
                    input_img_li.style.listStyle = "none";
                    input_img_li.id = "input_img_li_"+i;
                    input_img_li.style.width = "53px";
                    input_img_li.style.height = "100%";
                    input_img_li.style.display = "inline-block";
                    input_img_li.style.marginRight = "10px";
                    var input_img_tag = document.createElement("img");
                    input_img_tag.src = test_img_uris[i];
                    input_img_tag.id = "input_sample_img_"+i;
                    input_img_tag.style.width = "50px";
                    input_img_tag.style.height = "50px";
                    input_img_tag.style.opacity = "0.5";
                    input_img_tag.onclick = ()=>{
                      console.log("input spike display img idx "+i);
                      if(prev_clicked_input_li !== undefined){
                        document.getElementById(prev_clicked_input_li).style.backgroundColor ="";
                      }
                      document.getElementById("input_img_li_"+i).style.backgroundColor = "chocolate";
                      prev_clicked_input_li = "input_img_li_"+i;
                      console.log("Current cls_names="+infos.spikes.snn_input_spikes[i].cls_names);
                      console.log("Current spike data="+infos.spikes.snn_input_spikes[i].spike_tuples);
                      display_input_spikes_scatter_chart(infos.spikes.snn_input_spikes[i].cls_names, infos.spikes.snn_input_spikes[i].spike_tuples);
                    };
                    input_img_li.appendChild(input_img_tag);
                    document.getElementById("input_spike_sample_imgs_ul").appendChild(input_img_li);
                    // var layer_li = document.createElement("li");
                    // layer_li.style.listStyle="circle";
                    // layer_li.id = "input_layer_li_"+i;
                    // document.getElementById("layer_indexs").appendChild(layer_li);
                    // layer_li.onclick = ()=>{
                    //   console.log("Input layer "+i+" is clicked");
                    //   // display input spike
                    //   display_input_spikes_scatter_chart(infos.spikes.snn_input_spikes[i].cls_names, infos.spikes.snn_input_spikes[i].spike_tuples);
                    // };
                  }

                  // mark reds
                  for(let i=0;i<need_red_img_li.length;++i){
                    if(prev_clicked_li === need_red_img_li[i]){
                      document.getElementById(need_red_img_li[i]).style.backgroundColor = "yellow";  
                    }else{
                      document.getElementById(need_red_img_li[i]).style.backgroundColor = "red";
                    }
                  }

                  
                  // 神经元放电图
                  let tms = infos.record_layer_v.tms;
                  let v_vals = infos.record_layer_v.vals;
                  let data_series_input = new Array();
                  let data_series_output = new Array();

                  data_series_input.push({
                    "data": v_vals[0],
                    "type":"line",
                    "smooth":true,
                    "name":"脉冲激发次数最少的神经元膜电压"
                  });
                  data_series_input.push({
                    "data":v_vals[1],
                    "type":"line",
                    "smooth":true,
                    "yAxisIndex":1,
                    "name":"脉冲激发次数最多的神经元膜电压"
                  });

                  data_series_output.push({
                    "data": v_vals[2],
                    "type": "line",
                    "smooth":true,
                    "name": "脉冲激发次数最少的神经元膜电压"
                  });

                  data_series_output.push({
                    "data": v_vals[3],
                    "type":"line",
                    "smooth":true,
                    "yAxisIndex":1,
                    "name":"脉冲激发次数最多的神经元膜电压"
                  });

                  display_neuron_v_linechart(tms[0], data_series_input);

                  $("#select_which_layer").change(()=>{
                    let select_layer_val = $("#select_which_layer").val();
                    if(select_layer_val === "输入层"){
                      display_neuron_v_linechart(tms[0], data_series_input);
                      console.log("显示输入层：tms[0]="+tms[0]);
                      console.log("显示输入层：data_series="+data_series_input);
                    }else{
                      display_neuron_v_linechart(tms[0], data_series_output);
                      console.log("显示输出层：tms[0]="+tms[0]);
                      console.log("显示输出层：data_series="+JSON.stringify(data_series_output));
                    }
                  });

                  // fill tables
                  $("#simulate_vthresh").text(infos.extra_simu_info.simulate_vthresh);
                  $("#simulate_neuron_dt").text(infos.extra_simu_info.simulate_neuron_dt);
                  $("#simulate_synapse_dt").text(infos.extra_simu_info.simulate_synapse_dt);
                  $("#simulate_delay").text(infos.extra_simu_info.simulate_delay);
                  $("#simulate_dura").text(infos.extra_simu_info.simulate_dura);
                  $("#simulate_acc").text(infos.extra_simu_info.simulate_acc);


                  // fill layers spike info table
                  // $("#snn_layers_spike_table")
                  for(let j=0;j<infos.record_spike_out_info.spike_count_avgs.length;++j){
                    let table_line = document.createElement("tr");
                    table_line.style.height = "25px";
                    table_line.style.border = "solid 2px #D6D6D6";
                    table_line.style.color = "#333";

                    let td_id = document.createElement("td");
                    td_id.style.fontSize = "medium";
                    td_id.style.paddingLeft= "15px";
                    td_id.style.border = "solid 2px #D6D6D6";
                    td_id.innerText = "layer_"+j;
                    table_line.appendChild(td_id);

                    let td_spike_avg = document.createElement("td");
                    td_spike_avg.style.fontSize = "medium";
                    td_spike_avg.style.paddingLeft = "15px";
                    td_spike_avg.style.order = "solid 2px #D6D6D6";
                    td_spike_avg.innerText = infos.record_spike_out_info.spike_count_avgs[j];
                    table_line.appendChild(td_spike_avg);

                    let td_spike_std = document.createElement("td");
                    td_spike_std.style.fontSize = "medium";
                    td_spike_std.style.paddingLeft = "15px";
                    td_spike_std.style.border = "solid 2px #D6D6D6";
                    td_spike_std.innerText = infos.record_spike_out_info.spike_count_stds[j];
                    table_line.appendChild(td_spike_std);

                    document.getElementById("snn_layers_spike_table").appendChild(table_line);
                  }
              }
          });
      });

      function multiple_argmax(lst){
        tmp_lst = new Array();
        for(let i=0;i<lst.length;++i){
          tmp_lst.push(parseInt(lst[i]));
        }
        tmp_lst.sort((a,b)=>{return a-b;}).reverse()
        console.log("check with multiple_argmax, lst="+tmp_lst);
        console.log("---after sort [0]="+tmp_lst[0]+" [1]="+tmp_lst[1]);
        if(tmp_lst[0] === tmp_lst[1]){
          return true;
        }else{
          return false;
        }
      }


      function my_argmax(lst){
        let max_val=0, max_idx=0;
        for(let i=0;i<lst.length;++i){
          if(lst[i] > max_val){
            max_val = lst[i];
            max_idx = i;
          }
        }
        return max_idx;
      }

      function calc_need_red(test_img_spikes, test_img_uris){
        // label_span.innerText = "标签: "+test_img_uris[i].split("/")[5].split("_")[4].split(".")[0];
        for(let i=0;i<test_img_spikes.length;++i){
          console.log("test_img_spikes i="+i+"  spike tuples="+test_img_spikes[i].spike_tuples);
          let cls_idx = 0;
          if(test_img_spikes[i].spike_tuples.length > 0){
            cls_idx = test_img_spikes[i].spike_tuples[0][0];
          }
          let curr_count=1;
          let spike_counts = new Array();
          for(let j=0;j<test_img_spikes[i].cls_names.length;++j){
              spike_counts.push(0);
          }
          for(let j=1;j<test_img_spikes[i].spike_tuples.length;++j){
              if(cls_idx === test_img_spikes[i].spike_tuples[j][0]){
                  curr_count = curr_count+1;
              }else{
                  spike_counts[cls_idx] = curr_count;
                  curr_count=1;
                  cls_idx = test_img_spikes[i].spike_tuples[j][0];
              }
          }
          if(spike_counts.length > 0){
            spike_counts[cls_idx] = curr_count;
          }
          console.log("current check img:"+i+", spike_counts="+spike_counts);
          if(parseInt(test_img_uris[i].split("/")[5].split("_")[4].split(".")[0]) !== my_argmax(spike_counts)){
            need_red_img_li.push("img_li_"+i);
          }else if(multiple_argmax(spike_counts)){
            console.log("--after check multiple armax, true");
            need_red_img_li.push("img_li_"+i);
            console.log("img: "+i+" need mark.");
          }else{
            console.log("img " +  i+ " ok");
          }
        }
      }

      function display_spike_scatter_chart(labels, datas){
          var opt={
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: '#999'
                        }
                    }
                },
                xAxis: {
                    type:'category',
                    data: labels,
                    name: "类别",
                    nameTextStyle:{
                      color:"black"
                    },
                    axisLabel:{
                      textStyle:{
                          color:"black"
                      }
                   }
                },
                yAxis: {
                    type: 'value',
                    scale:true,
                    name:"时间(brian2 ms)",
                    nameTextStyle:{
                      color:"black"
                    },
                    axisLabel: {
                        formatter: '{value}',
                        textStyle:{
                            color:"black"
                        }
                    }
                },
                series: [{
                    symbolSize: 5,
                    data: datas,
                    type: 'scatter'
                }]
            };
            var spike_chart = echarts.init(document.getElementById("spike_charts"));
            spike_chart.setOption(opt);
      }



      function display_input_spikes_scatter_chart(labels, datas){
          var opt={
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: '#999'
                        }
                    }
                },
                xAxis: {
                    type:'category',
                    data: labels,
                    name: "ID",
                    nameTextStyle:{
                      color:"black"
                    },
                    axisLabel:{
                      textStyle:{
                          color:"black"
                      }
                   }
                },
                yAxis: {
                    type: 'value',
                    scale:true,
                    name:"时间(brian2 ms)",
                    nameTextStyle:{
                      color:"black"
                    },
                    axisLabel: {
                        formatter: '{value}',
                        textStyle:{
                            color:"black"
                        }
                    }
                },
                series: [{
                    symbolSize: 5,
                    data: datas,
                    type: 'scatter'
                }]
            };
            var spike_chart = echarts.init(document.getElementById("input_spike_charts"));
            spike_chart.setOption(opt);
      }

      function display_neuron_v_linechart(labels, series_vals){
          let option = {
              tooltip:{
                trigger:"axis"
              },
              legend:{
                data:["脉冲激发次数最少的神经元膜电压", "脉冲激发次数最多的神经元膜电压"],
                textStyle:{
                  color:"black"
                }
              },
              grid:{
                right:100
              },
              xAxis: {
                  type: 'category',
                  data: labels,
                  scale:true,
                  name:"时间",
                  nameGap:40,
                  nameTextStyle:{
                    color:"black"
                  },
                  axisLabel:{
                    textStyle:{
                      color:"black"
                    }
                  }
              },
              yAxis: [
                {
                    type: 'value',
                    scale:true,
                    name:"膜电压(左)",
                    nameTextStyle:{
                      color:"black"
                    },
                    axisLabel:{
                      textStyle:{
                        color:"black"
                      }
                    }
                },
                {
                  type: 'value',
                    scale:true,
                    name:"膜电压(右)",
                    nameTextStyle:{
                      color:"black"
                    },
                    axisLabel:{
                      textStyle:{
                        color:"black"
                      }
                    } 
                }
              ],
              series: series_vals
          };

          var v_val_chart = echarts.init(document.getElementById("neurons_v_chart"));
          v_val_chart.setOption(option);
      }
</script>

</html>